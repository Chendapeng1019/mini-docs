# 服务器

本文档主要用于记录服务器相关命令和脚本,请知悉.

以下命令基于`centos7`操作系统.

## 1. CentOS7 与防火墙

在 CentOS7 里面防火墙的命令变了,很多,很多,很多.

### 1.1 常用命令

**查看状态**

```shell
[root@team-2 ~]# systemctl status firewalld
```

**开启防火墙**

```shell
[root@team-2 ~]# systemctl start firewalld
```

**关闭防火墙**

```shell
[root@team-2 ~]# systemctl stop firewalld
```

**禁用防火墙**

```shell
[root@team-2 ~]# systemctl disable firewalld
```

### 1.2 开启端口

**开启端口**

```shell
[root@team-2 ~]# firewall-cmd --add-port=7003/tcp --zone=public --permanent
[root@team-2 ~]# firewall-cmd --reload
```

**查看已开启端口**

```shell
[root@team-2 ~]# firewall-cmd --list-port
```

**移除端口**

```shell
[root@team-2 ~]# firewall-cmd --remove-port=4993/tcp
[root@team-2 ~]# firewall-cmd --reload
```

---

## 2. 服务器资源

我们该如何查看服务器中的磁盘和内存呢?

### 2.1 磁盘

**查看磁盘容量**

```shell
[root@team-2 ~]# df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/vda1        40G  7.8G   30G  21% /
devtmpfs        911M     0  911M   0% /dev
tmpfs           920M     0  920M   0% /dev/shm
tmpfs           920M  428K  920M   1% /run
tmpfs           920M     0  920M   0% /sys/fs/cgroup
tmpfs           184M     0  184M   0% /run/user/0
```

**查看当前文件夹占用大小**

```shell
[root@team-2 opt]# du -sh *
189M	pkgs
8.0K	server-doc.md
531M	soft
[root@team-2 opt]#
```

### 2.2 内存

**查看内存**

- `-g`:按照 GB 来显示.
- `-m`:按照 MB 来显示.

```shell
[root@team-2 ~]# free -g
                total        used        free      shared  buff/cache   available
Mem:              1           0           0           0           0           0
Swap:             0           0           0
[root@team-2 ~]# free -m
               total        used        free      shared  buff/cache   available
Mem:           1839         845          86           0         906         810
Swap:           511           0         511
```

### 2.3 top 命令

使用 top 命令可以查看进程的 cpu 和内存占用比

```shell
[root@team-2 ~]# top -u root

Tasks:  73 total,   1 running,  72 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.3 us,  0.7 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  1883492 total,    88396 free,   866548 used,   928548 buff/cache
KiB Swap:   524284 total,   524284 free,        0 used.   829512 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
 2342 root      20   0   37212   9824    404 S  0.3  0.5   8:04.28 Linux2.6
18766 root      20   0   85488    828    404 S  0.3  0.0 123:17.20 slm
31198 root      20   0   75248    764    392 S  0.3  0.0  10:48.20 slm
```

---

## 3. 查找进程

在服务器中我们该怎么查找到特定的进程?

### 3.1 按端口号

一般`netstat`命令用来查找端口是否被使用,而使用情况要使用`ps`命令来查看.

```shell
[root@team-2 ~]# netstat -lnp|grep 8080
tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      11735/java
[root@team-2 ~]# ps -ef|grep 11735
root     11735     1  0 Aug21 ?        00:34:09 /opt/soft/jdk/jdk1.8/bin/java -Djava.util.logging.config.file=/opt/soft/tomcat/tomcat8/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dignore.endorsed.dirs= -classpath /opt/soft/tomcat/tomcat8/bin/bootstrap.jar:/opt/soft/tomcat/tomcat8/bin/tomcat-juli.jar -Dcatalina.base=/opt/soft/tomcat/tomcat8 -Dcatalina.home=/opt/soft/tomcat/tomcat8 -Djava.io.tmpdir=/opt/soft/tomcat/tomcat8/temp org.apache.catalina.startup.Bootstrap start
```

### 3.2 按进程名称

- `grep -v 'str'`: 不匹配 str

```shell
[root@team-2 ~]# ps -ef |grep english |grep -v 'grep'
root     30337     1  0 Sep05 ?        00:11:23 java -jar app/english-web-0.0.1-SNAPSHOT.jar
```

### 3.3 jps 命令

该命令为 java 专有,必须安装**jdk 环境**,且显示出来都是 jvm 的进程.

```shell
[root@team-2 ~]# jps -lm
30337 app/english-web-0.0.1-SNAPSHOT.jar
11735 org.apache.catalina.startup.Bootstrap start
20665 sun.tools.jps.Jps -lm
11609 org.fengfei.lanproxy.server.ProxyServerContainer
```

### 3.4 kill

用来杀死进程,用来强制杀死进程!!!

- 命令格式: `kill -9 pid`

```shell
[root@team-2 ~]# kill -9 11735
```

---

## 4. 服务器文件传输

### 4.1 文件压缩

服务器中经常遇到要将多个文件压缩成一个压缩包的情况,仅仅是 tar 只会把文件打包而不会压缩,所以将文件压缩为 gz 的压缩包.

`pkgs.tar.gz`: 自定义压缩包名称.

`pkgs`: 将要被压缩的文件夹.

```shell
[root@team-2 opt]# tar -zcvf pkgs.tar.gz pkgs/
```

### 4.2 文件解压

一般压缩包有两种格式:`tar`和`zip`,嗯,是的,对`rar`很排斥.

**解压 tar**

```shell
[root@team-2 opt]# tar -xvf pkgs.tar.gz
```

**解压 zip**

```shell
[root@team-2 opt]# unzip yourZip.zip
```

### 4.3 服务器之间文件传输

在服务器之间,怎么传输文件呢?不会是用 U 盘 copy 来 copy 去吧?

放心,服务器有`scp`命令, `scp -r pkgs 目标服务器用户@目标服务器ip:存放文件夹`.

- `scp file`: 传输单个文件.
- `scp -r pkgs/`:传输整一个文件夹.

```shell
[root@team-2 ~]# scp -r pkgs/ root@10.10.1.224:/tmp/
```

---

## 5. 服务器用户

### 5.1 新增用户

`useradd -m -d`: 创建并指定 home 目录.

`passwd user`: 为新创建用户创建密码.

```shell
hadoop231:~ # useradd haiyan -m -d /opt/haiyan
hadoop231:~ # passwd haiyan
Changing password for haiyan.
New Password:
Bad password: too simple
Reenter New Password:
Password changed.
```

### 5.2 改变目录拥有者

有些时候,将某些目录赋给某个用户,让用户拥有那个目录的所有权限.

```shell
hadoop231:/opt/soft # mkdir root-dir
hadoop231:/opt/soft # ll
drwxr-xr-x 2 root root 4096 Sep 15 23:15 root-dir
hadoop231:/opt/soft # id haiyan
uid=1001(haiyan) gid=100(users) groups=16(dialout),33(video),100(users)
hadoop231:/opt/soft # chown haiyan:users -R root-dir/
hadoop231:/opt/soft # ll
drwxr-xr-x 2 haiyan users 4096 Sep 15 23:15 root-dir
```

在 linux 里面,一个文件有`r(read)`,`w(write)`,`x(execute)`分别对应着:4,2,1 数值.

那么上面的`drwxr-xr-x`是什么意思呢?

最前面的`d`代表`文件夹`,后面每三个字符为一组,分别代表着:当前用户的拥有的权限,当组用户拥有的权限,其他用户拥有的权限.

---

## 6. maven 打包

### 6.1 普通

下面的命令打包会运行 test 文件夹里面的代码,如果 test 代码要运行很久,请使用`6.2`的打包方式.

```shell
[root@team-2 ~]# mvn clean package
```

### 6.2 跳过测试打包

打包推荐使用如下命令

```shell
[root@team-2 ~]# mvn clean package -Dmaven.test.skip=true
```

---

## 7. 时间设置

### 7.1 date

**设置日期**

```shell
hadoop235:/etc # date -s  20181008
```

**设置时间**

```shell
hadoop235:/etc # date -s  10:19:40
```

### 7.2 ntp

集群里面有些节点的时间可能会出现差异,所以使用阿里云的时间服务器同步互联网时间,用来规范集群里面的每一个节点的时间.

```shell
hadoop235:/etc # date -s  10:20:10
Mon Oct  8 10:20:10 CST 2018
hadoop235:/etc # date
Mon Oct  8 10:20:17 CST 2018
hadoop235:/etc # sntp -P no -r ntp1.aliyun.com
hadoop235:/etc # date
Mon Oct  8 10:18:34 CST 2018
```

加入定时任务

```shell
hadoop235:/etc # crontab -e

# 每五分钟同步一次
*/5 * * * * /usr/sbin/sntp -P no -r ntp1.aliyun.com
```

### 7.3 crontab

命令格式: `* * * * * command`

> 分　 时　 日　 月　 周　 命令
>
> 第 1 列表示分钟 1 ～ 59 每分钟用*或者 */1 表示
>
> 第 2 列表示小时 1 ～ 23（0 表示 0 点）
>
> 第 3 列表示日期 1 ～ 31
>
> 第 4 列表示月份 1 ～ 12
>
> 第 5 列标识号星期 0 ～ 6（0 表示星期天）
>
> 第 6 列要运行的命令

相关例子

每 5 分钟执行一次: `*/5 * * * * /home/a.sh`

每天凌晨 2 点执行一次: `0 2 * * * /home/a.sh`

---

## 8. 软件安装

在 linux 上最方便的两种安装软件的方式,编译的那些都是逆天的. :{

### 8.1 yum

**查找软件**

```shell
[root@hadoop235 ~]# yum list git
[root@hadoop235 ~]# yum list |grep git
```

**安装软件**

```shell
[root@hadoop235 ~]# yum install -y git.x86_64
```

**卸载软件**

```shell
[root@hadoop235 ~]# yum remove -y git.x86_64
```

**查询本地是否安装**

```shell
[root@hadoop235 ~]# yum list  installed |grep git.x86_64
```

**只下载不安装**

```shell
[root@hadoop235 ~]# yum install -y --downloadonly --downloaddir=git-rpm/ git.x86_64
```

### 8.2 rpm

切记: `能升级更新软件,就绝壁不要强制安装了` 笑哭脸.jpg

**安装软件**

```shell
[root@hadoop235 git-rpm]# rpm -ivh perl-Git-1.8.3.1-14.el7_5.noarch.rpm  git-1.8.3.1-14.el7_5.x86_64.rpm
```

**更新软件**

```shell
[root@hadoop235 git-rpm]# rpm -Uvh git-1.8.3.1-14.el7_5.x86_64.rpm
```

**查询软件**

```shell
[root@hadoop235 git-rpm]# rpm -qa|grep git
git-1.8.3.1-14.el7_5.x86_64
```

**卸载软件**

```shell
[root@hadoop235 git-rpm]# rpm -e --nodeps  git-1.8.3.1-14.el7_5.x86_64
```
